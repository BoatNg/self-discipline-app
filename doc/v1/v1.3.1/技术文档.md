å¥½çš„ï¼é’ˆå¯¹ä½ çš„ **Vue PWA åº”ç”¨**ï¼Œç›®æ ‡æ˜¯ï¼š

- ç”¨æˆ·ç‚¹å‡» Supabase é‚®ä»¶ä¸­çš„é“¾æ¥ï¼ˆå¦‚é­”æ³•ç™»å½•ã€å¯†ç é‡ç½®ç­‰ï¼‰åï¼Œè·³è½¬åˆ°ä½ æŒ‡å®šçš„å›è°ƒé¡µï¼›
- è¯¥é¡µé¢ **ä¸è·³è½¬åˆ°ç™»å½•é¡µ**ï¼Œè€Œæ˜¯ **ç›´æ¥å¤„ç†è®¤è¯å¹¶å±•ç¤ºæˆåŠŸ/å¤±è´¥çŠ¶æ€**ï¼›
- ä¿æŒè½»é‡ï¼Œä»…ç”¨äºæ‰¿æ¥å›è°ƒã€‚

ä»¥ä¸‹æ˜¯å®Œæ•´çš„ **Vue æŠ€æœ¯æ–¹æ¡ˆ**ï¼ˆé€‚ç”¨äº Vue 3 + Composition APIï¼‰ã€‚

---

## âœ… ä¸€ã€Supabase åå°é…ç½®ï¼ˆå‰æï¼‰

å·²å®Œæˆ

---

## âœ… äºŒã€åˆ›å»º Vue å›è°ƒé¡µé¢ï¼š`/src/views/AuthCallback.vue`

```vue
<!-- src/views/AuthCallback.vue -->
<template>
  <div class="auth-callback">
    <div v-if="loading" class="status">æ­£åœ¨éªŒè¯èº«ä»½...</div>
    <div v-else-if="error" class="status error">âŒ {{ error }}</div>
    <div v-else class="status success">âœ… èº«ä»½éªŒè¯æˆåŠŸï¼</div>
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue';
import { supabase } from '@/lib/supabaseClient'; // ä½ çš„ Supabase å®¢æˆ·ç«¯
import { useRouter } from 'vue-router';

const loading = ref(true);
const error = ref(null);
const countdown = ref(3);
const router = useRouter();

onMounted(async () => {
  try {
    // å…³é”®ï¼šä» URL ä¸­æå– token å¹¶å®Œæˆç™»å½•
    const { error: authError } = await supabase.auth.getSessionFromUrl();
    
    if (authError) {
      throw new Error(authError.message || 'è®¤è¯å¤±è´¥');
    }

    // æ¸…é™¤ URL ä¸­çš„æ•æ„Ÿå‚æ•°ï¼ˆç¾è§‚ + å®‰å…¨ï¼‰
    window.history.replaceState({}, document.title, window.location.pathname);


  } catch (err) {
    console.error('Auth callback error:', err);
    error.value = err.message || 'æœªçŸ¥é”™è¯¯ï¼Œè¯·é‡è¯•ã€‚';
  } finally {
    loading.value = false;
  }
});
</script>

<style scoped>
.auth-callback {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  padding: 20px;
  background: #f9fafb;
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
}

.status {
  font-size: 1.2rem;
  margin-bottom: 16px;
  text-align: center;
}

.success {
  color: #10b981;
}

.error {
  color: #ef4444;
}
</style>
```

---

## âœ… ä¸‰ã€é…ç½®è·¯ç”±ï¼ˆVue Routerï¼‰

åœ¨ `src/router/index.js`ï¼ˆæˆ– `.ts`ï¼‰ä¸­æ·»åŠ è·¯ç”±ï¼š

```js
// src/router/index.js
import { createRouter, createWebHistory } from 'vue-router';
import AuthCallback from '@/views/AuthCallback.vue';

const routes = [
  // ... å…¶ä»–è·¯ç”±
  {
    path: '/auth/callback',
    name: 'AuthCallback',
    component: AuthCallback,
    meta: { public: true } // å¦‚æœä½ æœ‰å…¨å±€å®ˆå«ï¼Œæ ‡è®°ä¸ºæ— éœ€ç™»å½•
  }
];

const router = createRouter({
  history: createWebHistory(),
  routes
});

export default router;
```

> ğŸ”‘ ç¡®ä¿ä½¿ç”¨ **`createWebHistory()`ï¼ˆHTML5 History æ¨¡å¼ï¼‰**ï¼Œä¸èƒ½ç”¨ hash æ¨¡å¼ï¼

---

## âœ… å››ã€å…³é”®è¯´æ˜

| è¦ç‚¹ | è¯´æ˜ |
|------|------|
| **`getSessionFromUrl()`** | Supabase SDK ä¼šè‡ªåŠ¨è§£æ `?access_token=...` å¹¶è®¾ç½® sessionï¼Œè§¦å‘ `onAuthStateChange` |
| **æ¸…é™¤ URL å‚æ•°** | `window.history.replaceState(...)` é˜²æ­¢ token æ®‹ç•™åœ¨æµè§ˆå™¨å†å² |
| **ä¸è·³è½¬ç™»å½•é¡µ** | æˆåŠŸåç›´æ¥å±•ç¤ºçŠ¶æ€ |
| **é”™è¯¯å±•ç¤º** | æ˜¾ç¤ºå…·ä½“é”™è¯¯ä¿¡æ¯ï¼Œä¾¿äºè°ƒè¯• |
| **PWA å…¼å®¹** | è¯¥é¡µé¢å¯è¢« Service Worker ç¼“å­˜ï¼ˆå»ºè®®è®¾ä¸º network-firstï¼‰ |

---

## âœ… äº”ã€ï¼ˆå¯é€‰ï¼‰å…¨å±€ç›‘å¬ç™»å½•çŠ¶æ€

å¦‚æœä½ å…¶ä»–é¡µé¢éœ€è¦å“åº”ç™»å½•çŠ¶æ€å˜åŒ–ï¼Œå¯åœ¨ `main.js` ä¸­ç›‘å¬ï¼š

```js
// main.js
supabase.auth.onAuthStateChange((event, session) => {
  console.log('Auth state changed:', event);
  // å¯æ›´æ–° pinia/vuex store æˆ–å…¨å±€çŠ¶æ€
});
```

---

## âœ… å…­ã€æµ‹è¯•æµç¨‹

1. åœ¨ä½ çš„ PWA ä¸­è°ƒç”¨ï¼š
   ```js
   await supabase.auth.signInWithOtp({ email: 'test@example.com' });
   ```
2. æŸ¥æ”¶é‚®ä»¶ï¼Œç‚¹å‡»é“¾æ¥
3. æµè§ˆå™¨æ‰“å¼€ `https://your-pwa.com/auth/callback?access_token=...`
4. é¡µé¢æ˜¾ç¤ºâ€œâœ… èº«ä»½éªŒè¯æˆåŠŸï¼â€
5. æ­¤æ—¶ `supabase.auth.getUser()` åº”è¿”å›å·²ç™»å½•ç”¨æˆ·

---

## âœ… ä¸ƒã€å®‰å…¨å»ºè®®

- è¯¥é¡µé¢ä¸è¦ç¼“å­˜æ•æ„Ÿä¿¡æ¯ï¼ˆtoken å·²ç”± SDK å¤„ç†ï¼‰
- ä¸è¦å°† `access_token` æ‰“å°åˆ°æ§åˆ¶å°æˆ–æ—¥å¿—ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
- ç¡®ä¿éƒ¨ç½²ç¯å¢ƒå¯ç”¨äº† HTTPSï¼ˆSupabase ç”Ÿäº§é‚®ä»¶åªå‘ https é“¾æ¥ï¼‰

---

è¿™æ ·ä½ å°±æœ‰äº†ä¸€ä¸ª **è½»é‡ã€ä¸“æ³¨ã€ç”¨æˆ·ä½“éªŒå‹å¥½** çš„ Vue å›è°ƒé¡µé¢ï¼Œå®Œå…¨æ»¡è¶³â€œåªå±•ç¤ºç»“æœã€ä¸è·³ç™»å½•é¡µâ€çš„éœ€æ±‚ã€‚
